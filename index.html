<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vertriebspartner</title>

  <style>
    :root{
      --bg:#f4f8ff;
      --panel:#ffffff;
      --text:#0b1b33;
      --muted:#51627a;
      --line:rgba(11,27,51,.14);
      --shadow:0 10px 28px rgba(11,27,51,.10);
      --radius:18px;
      --pad:18px;

      /* default theme (falls kein Partner gew√§hlt) */
      --pf-main:#1d4ed8;
      --pf-soft:rgba(29,78,216,.14);
      --pf-soft2:rgba(29,78,216,.08);

      --ok:rgba(16,185,129,.16);
      --warn:rgba(245,158,11,.16);
      --bad:rgba(244,63,94,.16);
    }

    /* Partner-Farben (unterschiedlich) */
    body[data-partner="fonds_finanz"]{ --pf-main:#2563eb; --pf-soft:rgba(37,99,235,.14); --pf-soft2:rgba(37,99,235,.08); }
    body[data-partner="demv"]{        --pf-main:#059669; --pf-soft:rgba(5,150,105,.14);  --pf-soft2:rgba(5,150,105,.08);  }
    body[data-partner="taures"]{      --pf-main:#7c3aed; --pf-soft:rgba(124,58,237,.14); --pf-soft2:rgba(124,58,237,.08); }
    body[data-partner="tvd"]{         --pf-main:#ea580c; --pf-soft:rgba(234,88,12,.14);  --pf-soft2:rgba(234,88,12,.08);  }
    body[data-partner="wir_finanz"]{  --pf-main:#0ea5e9; --pf-soft:rgba(14,165,233,.14); --pf-soft2:rgba(14,165,233,.08); }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% 10%, var(--pf-soft), transparent 55%),
        radial-gradient(1200px 800px at 85% 85%, var(--pf-soft2), transparent 55%),
        linear-gradient(180deg, #eef6ff, var(--bg));
    }

    header{
      padding:18px 22px 10px 22px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800; letter-spacing:.2px;
      font-size:20px;
    }
    .pill{
      font-size:12px;
      color:var(--pf-main);
      background:var(--pf-soft2);
      border:1px solid color-mix(in srgb, var(--pf-main) 35%, transparent);
      padding:4px 10px;
      border-radius:999px;
      font-weight:700;
    }

    .topActions{
      display:flex; flex-wrap:wrap; gap:8px;
      align-items:center; justify-content:flex-end;
    }

    button, .btn, select, input, textarea{
      font:inherit;
    }
    button, .btn{
      border:1px solid color-mix(in srgb, var(--pf-main) 25%, var(--line));
      background:var(--panel);
      color:var(--text);
      border-radius:12px;
      padding:9px 12px;
      box-shadow: 0 6px 16px rgba(11,27,51,.06);
      cursor:pointer;
      user-select:none;
    }
    button.primary{
      background:var(--pf-main);
      border-color:color-mix(in srgb, var(--pf-main) 70%, #000);
      color:#fff;
      font-weight:800;
    }
    button.ghost{
      background:transparent;
      box-shadow:none;
    }
    button.danger{
      border-color: rgba(244,63,94,.45);
      color:#be123c;
    }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .container{
      display:grid;
      grid-template-columns: 440px 1fr; /* linke Seite gr√∂√üer */
      gap:18px;
      padding:0 22px 22px 22px;
    }

    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding: var(--pad);
    }

    .muted{ color:var(--muted); }
    .small{ font-size:12px; color:var(--muted); }
    .h2{
      font-size:16px; font-weight:900; margin:0 0 10px 0;
      display:flex; align-items:center; gap:10px;
    }
    .divider{ height:1px; background:var(--line); margin:14px 0; }

    .row{ display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap; }
    .field{
      display:flex; flex-direction:column; gap:6px;
      min-width: 120px;
      flex: 1 1 180px;
    }
    .field.w2{ flex: 0 0 calc(16.666% - 10px); min-width:110px; }
    .field.w3{ flex: 0 0 calc(25% - 10px); min-width:150px; }
    .field.w4{ flex: 0 0 calc(33.333% - 10px); min-width:180px; }
    .field.w6{ flex: 0 0 calc(50% - 10px); min-width:220px; }
    .field.w12{ flex: 0 0 100%; min-width: 100%; }

    label{ font-size:12px; color:var(--muted); font-weight:800; }
    input, select, textarea{
      border:1px solid var(--line);
      background: #fff;
      color:var(--text);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
    }
    textarea{ min-height:86px; resize:vertical; }
    input:focus, select:focus, textarea:focus{
      border-color: color-mix(in srgb, var(--pf-main) 45%, var(--line));
      box-shadow: 0 0 0 4px var(--pf-soft2);
    }

    .chipRow{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .chip{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: #fff;
      display:inline-flex; gap:6px; align-items:center;
    }
    .chip.ok{ background:var(--ok); border-color: color-mix(in srgb, #10b981 40%, var(--line)); }
    .chip.warn{ background:var(--warn); border-color: color-mix(in srgb, #f59e0b 40%, var(--line)); }
    .chip.bad{ background:var(--bad); border-color: color-mix(in srgb, #f43f5e 40%, var(--line)); }
    .chip strong{ font-weight:900; }

    .partnerTabs{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;
    }
    .tab{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      cursor:pointer;
      background:#fff;
      user-select:none;
      font-weight:800;
      font-size:13px;
    }
    .tab.active{
      background: var(--pf-soft2);
      border-color: color-mix(in srgb, var(--pf-main) 45%, var(--line));
      color: var(--pf-main);
    }

    .selectWide{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--line);
    }

    .stammdatenBox{
      border:1px solid color-mix(in srgb, var(--pf-main) 26%, var(--line));
      background:
        linear-gradient(180deg, var(--pf-soft2), rgba(255,255,255,.94));
      border-radius:16px;
      padding:14px;
      margin: 8px 0 14px 0;
      box-shadow: 0 10px 22px rgba(11,27,51,.06);
    }
    .stammdatenTitle{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom:10px;
    }
    .stammdatenTitle .tag{
      font-size:11px;
      font-weight:900;
      letter-spacing:.06em;
      text-transform:uppercase;
      color:var(--pf-main);
      background:var(--pf-soft);
      border:1px solid color-mix(in srgb, var(--pf-main) 35%, transparent);
      padding:5px 10px;
      border-radius:999px;
    }

    .inline{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .iconBtn{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      text-decoration:none;
      color:inherit;
      font-weight:800;
      font-size:12px;
    }

    .rightTop{
      display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;
    }
    .filters{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .filters label{ font-size:12px; font-weight:800; color:var(--muted); display:flex; gap:6px; align-items:center; }
    .searchBar{
      display:flex; gap:10px; align-items:center; width:100%;
    }
    .searchBar input{
      width:100%;
      border-radius:999px;
      padding:10px 14px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      background:var(--pf-soft2);
      border:1px solid color-mix(in srgb, var(--pf-main) 35%, transparent);
      color:var(--pf-main);
      font-weight:900;
      font-size:12px;
    }

    table{ width:100%; border-collapse:collapse; }
    th,td{ border-bottom:1px solid var(--line); padding:8px 8px; font-size:12px; text-align:left; }
    th{ color:var(--muted); font-weight:900; }
    tr:hover td{ background: rgba(0,0,0,.02); }

    .yearCompact{ font-size:12px; }
    .yearCompact th, .yearCompact td{ padding:6px 8px; font-size:12px; }
    .yearCompact .badge{ padding:5px 8px; font-size:11px; }
    .yearCompact .chip{ padding:4px 8px; font-size:11px; }

    .no-print{ }
    @media print{
      header, .no-print{ display:none !important; }
      body{ background:#fff; }
      .container{ grid-template-columns: 1fr; padding:0; }
      .card{ box-shadow:none; border:1px solid #ddd; }
    }
  </style>
</head>

<body data-partner="fonds_finanz">
<header class="no-print">
  <div class="brand">
    Vertriebspartner <span class="pill" id="statusPill">bereit</span>
  </div>

  <div class="topActions">
    <button class="primary" id="btnSaveTop">Speichern</button>
    <button id="btnPrintTop">Drucken</button>
    <button id="btnAddCustomFieldTop">Neue Felder erstellen</button>
    <button class="danger" id="btnDeleteFieldTop">Feld l√∂schen</button>
    <button id="btnFocusFollowUpsTop">Wiedervorlage</button>
    <button id="btnFocusVollTop">Vollproduktion</button>
    <button id="btnFocusBeihilfeTop">Beihilfeproduktion</button>
    <button id="btnFocusZusatzTop">Zusatzproduktion</button>
    <button id="btnFocusBkvTop">bKV</button>
  </div>
</header>

<div class="container">
  <!-- LEFT -->
  <aside class="card">
    <div class="h2">Partner <span class="badge" id="activePartnerBadge">Fonds Finanz</span></div>
    <div class="small muted">Breite Felder + Partner-Farben + Favorit + Ampel + Kontakt-Historie + Online-Abschluss.</div>

    <div class="partnerTabs no-print" id="partnerTabs"></div>

    <div class="divider"></div>

    <div class="small muted"><strong>Reiter / Datensatz</strong></div>
    <select class="selectWide no-print" id="recordSelect"></select>

    <div class="row no-print" style="margin-top:10px">
      <button id="btnNewRecord" class="ghost">+ Neuer Reiter</button>
      <button id="btnDeleteRecord" class="danger ghost">Reiter l√∂schen</button>
    </div>

    <div class="divider"></div>

    <div class="chipRow">
      <span class="chip" id="chipFavorite">‚òÖ Favorit: <strong id="favText">Nein</strong></span>
      <span class="chip" id="chipAmpel">Ampel: <strong id="ampelText">‚Äî</strong></span>
    </div>

    <div class="row no-print" style="margin-top:10px">
      <a class="iconBtn" id="btnCopyAddress" href="javascript:void(0)">üìç Adresse kopieren</a>
      <a class="iconBtn" id="btnCopyPhone" href="javascript:void(0)">üìû Tel/Mobil kopieren</a>
      <a class="iconBtn" id="btnCall" href="javascript:void(0)">‚òéÔ∏è Anrufen</a>
      <a class="iconBtn" id="btnMail" href="javascript:void(0)">‚úâÔ∏è E-Mail</a>
    </div>

    <div class="divider"></div>

    <div class="inline no-print">
      <span class="small">Speicherung lokal im Browser (localStorage). Export/Import unten.</span>
    </div>

    <div class="row no-print" style="margin-top:10px">
      <div class="field w6">
        <button class="ghost" id="btnExport">Export (JSON)</button>
      </div>
      <div class="field w6">
        <label>Import (JSON)</label>
        <input type="file" id="importFile" accept="application/json" />
      </div>
    </div>

    <div class="row no-print" style="margin-top:10px">
      <div class="field w12">
        <label>Eigene Rollen als Standard hinzuf√ºgen (optional)</label>
        <div class="row">
          <div class="field w6">
            <input id="roleNewInput" placeholder="z. B. Key Account" />
          </div>
          <div class="field w6">
            <button class="ghost" id="btnAddRole">Rolle hinzuf√ºgen</button>
          </div>
        </div>
        <div class="small muted" id="roleCustomInfo"></div>
      </div>
    </div>
  </aside>

  <!-- RIGHT -->
  <main class="card">
    <div class="rightTop no-print">
      <div style="flex:1 1 520px; min-width:320px;">
        <div class="searchBar">
          <span class="badge">Suche</span>
          <input id="q" placeholder="Name, Firma, E-Mail, Mobil/Telefon, Adresse, MAK/Partnernr, Anlass, Notiz, WV ‚Ä¶" />
          <button class="ghost" id="btnClearQ">‚úï</button>
        </div>
      </div>
      <div class="filters">
        <label><input type="checkbox" id="chkAllPartners"> √ºber alle Partner</label>
        <label><input type="checkbox" id="chkOnlyOpen"> nur offene Wiedervorlagen</label>
        <label><input type="checkbox" id="chkOnlyYear"> nur Jahr</label>
      </div>
    </div>

    <div class="divider"></div>

    <div class="h2">√úbersicht</div>
    <div class="small muted">Summen (Monatssicht) aus Jahreswerten + offene Wiedervorlagen (aus Kontakt-Follow-ups).</div>

    <div class="divider"></div>

    <div class="row">
      <div class="field w12">
        <div class="h2" style="margin-bottom:6px;">Offene Wiedervorlagen <span class="badge" id="openCount">0</span></div>
        <div id="openList" class="small muted">‚Äî</div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="row">
      <div class="field w12">
        <div class="h2" style="margin-bottom:8px;">Jahresauswertung (Monat)</div>
        <div class="row no-print" style="margin-bottom:8px; align-items:center;">
          <div class="field w6">
            <label>Jahr</label>
            <select id="yearSelect"></select>
          </div>
          <div class="field w6" style="display:flex; gap:8px; flex-direction:row; align-items:flex-end; justify-content:flex-end;">
            <button class="ghost" id="btnYearCsv">CSV Export</button>
            <button class="ghost" id="btnYearPrint">Drucken</button>
          </div>
        </div>

        <div class="yearCompact" id="yearWrap">
          <table id="yearTable"></table>
          <div class="small muted" style="margin-top:8px;">
            Logik: Jahreswerte (Produktion/Ziele) werden gleichm√§√üig auf 12 Monate verteilt und dann pro Monat summiert.
          </div>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="h2">Trefferliste <span class="badge" id="hitBadge">0 Treffer</span></div>
    <div class="no-print">
      <button class="ghost" id="btnToggleHits">Trefferliste</button>
      <div id="hitsCard" class="card" style="margin-top:10px; box-shadow:none; display:none;"></div>
    </div>

    <div class="divider"></div>

    <div class="h2">Bearbeiten</div>
    <div id="form"></div>
  </main>
</div>

<script>
(() => {
  // ===============================
  // Config
  // ===============================
  const STORAGE_KEY = "vp_db_v1";

  const PARTNERS = [
    { key:"fonds_finanz", name:"Fonds Finanz", hasMak:true, roleType:"fonds" },
    { key:"demv", name:"DEMV", hasMak:true, roleType:"fonds" },
    { key:"taures", name:"Taures", hasMak:false, roleType:"account" },
    { key:"tvd", name:"TVD", hasMak:false, roleType:"account" },
    { key:"wir_finanz", name:"WIR-Finanz", hasMak:false, roleType:"account" }
  ];

  const ROLE_DROPDOWN_FONDS = [
    "Regionaldirektor",
    "RDPartner",
    "DirektPartner",
    "StrukturPartner",
    "Leiter Direkt",
    "Bank",
    "Marketing",
    "Bereichsleiter Vertrieb",
    "Leiter dezentraler Vertrieb",
    "Leiter Struktur"
  ];
  const ROLE_DROPDOWN_ACCOUNT = ["Account","Leiter","Bereichsleiter"];

  // Address AutoFill (Firma -> Adresse)
  const ADDRESS_BOOK = {
    "Fonds Finanz Maklerservice GmbH": {
      strasse: "Riesstra√üe 25",
      plz: "80992",
      ort: "M√ºnchen",
      land: "DE",
      telefon: ""
    }
  };

  // ===============================
  // Helpers
  // ===============================
  const $ = (id) => document.getElementById(id);
  const uid = () => Math.random().toString(36).slice(2,10) + "-" + Date.now().toString(36);

  function safeJSONParse(s, fallback){
    try { return JSON.parse(s); } catch { return fallback; }
  }

  function todayISO(){
    const d = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function currentYear(){ return new Date().getFullYear(); }
  function yearFromISO(iso){
    if(!iso || typeof iso !== "string") return null;
    const m = iso.match(/^(\d{4})-/);
    return m ? parseInt(m[1],10) : null;
  }
  function monthIndexFromISO(iso){
    if(!iso || typeof iso !== "string") return null;
    const m = iso.match(/^\d{4}-(\d{2})-/);
    if(!m) return null;
    const mm = parseInt(m[1],10);
    if(!(mm>=1 && mm<=12)) return null;
    return mm-1;
  }
  function moneyParse(v){
    if(v === null || v === undefined) return 0;
    const s = String(v).replace(/\./g,"").replace(",",".").replace(/[^\d.-]/g,"").trim();
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : 0;
  }
  function moneyFmt(n){
    const v = Number.isFinite(n) ? n : 0;
    return v.toLocaleString("de-DE", { minimumFractionDigits:0, maximumFractionDigits:0 });
  }
  function copyToClipboard(text){
    if(!text) return;
    navigator.clipboard?.writeText(text).catch(()=>{});
  }

  function applyAddressAutofill(rec){
    const key = (rec.firma || "").trim();
    const hit = ADDRESS_BOOK[key];
    if(!hit) return false;
    rec.strasse = rec.strasse || hit.strasse || "";
    rec.plz     = rec.plz || hit.plz || "";
    rec.ort     = rec.ort || hit.ort || "";
    rec.land    = rec.land || hit.land || "DE";
    rec.telefon = rec.telefon || hit.telefon || "";
    return true;
  }

  // ===============================
  // DB
  // ===============================
  function baseRecord(partner){
    const rec = {
      id: uid(),
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),

      favorit: false,
      onlineAbschluss: false,

      makNummer: "",
      partnerNummer: "",
      datum: todayISO(),

      rolle: "",
      rolleFrei: "",

      name: "",
      firma: "",
      email: "",
      mobil: "",
      telefon: "",

      strasse: "",
      plz: "",
      ort: "",
      land: "DE",

      optin: false,

      // Produktion/Ziele (Jahreswerte ‚Äì werden in Monats√ºbersicht gleichm√§√üig verteilt)
      prodVoll: "",  zielVoll: "",
      prodBeihilfe: "", zielBeihilfe: "",
      prodZusatz: "", zielZusatz: "",
      prodBkv: "", zielBkv: "",

      // Manuelle Jahres√ºbersicht (Ziel/Ist)
      gesamtZiel: "", gesamtIst: "",
      vollZiel: "", vollIst: "",
      beihilfeZiel: "", beihilfeIst: "",
      zusatzZiel: "", zusatzIst: "",
      pflegeZiel: "", pflegeIst: "",
      bkvZiel: "", bkvIst: "",
      reiseZiel: "", reiseIst: "",

      freiesFeld: "",

      // Kontakt-Historie: beliebig viele
      kontakte: [
        { id: uid(), datum: todayISO(), anlass:"", notiz:"", followUpDatum:"", followUpThema:"", followUpErledigt:false }
      ],

      custom: {}
    };

    if(!partner.hasMak) rec.makNummer = undefined;
    return rec;
  }

  function defaultState(){
    const partners = {};
    for(const p of PARTNERS){
      partners[p.key] = {
        customFields: [],
        roleCustom: [],
        records: [ baseRecord(p) ],
        activeRecordId: null
      };
      partners[p.key].activeRecordId = partners[p.key].records[0].id;
    }
    return {
      version: 1,
      ui: {
        activePartnerKey: PARTNERS[0].key,
        q: "",
        allPartners: false,
        onlyOpen: false,
        onlyYear: false,
        year: currentYear()
      },
      partners
    };
  }

  let db = null;

  function loadDB(){
    const raw = localStorage.getItem(STORAGE_KEY);
    db = raw ? safeJSONParse(raw, defaultState()) : defaultState();

    // Migration safety: ensure partner containers exist
    for(const p of PARTNERS){
      if(!db.partners[p.key]) db.partners[p.key] = { customFields:[], roleCustom:[], records:[], activeRecordId:null };
      const ps = db.partners[p.key];
      ps.customFields ||= [];
      ps.roleCustom ||= [];
      ps.records ||= [];
      if(ps.records.length === 0) ps.records.push(baseRecord(p));
      if(!ps.activeRecordId) ps.activeRecordId = ps.records[0].id;

      // Ensure fields exist
      for(const r of ps.records){
        r.custom ||= {};
        r.kontakte ||= [];
        if(!Array.isArray(r.kontakte) || r.kontakte.length === 0){
          r.kontakte = [{ id: uid(), datum: todayISO(), anlass:"", notiz:"", followUpDatum:"", followUpThema:"", followUpErledigt:false }];
        }
        r.updatedAt ||= r.createdAt || new Date().toISOString();
        r.telefon ??= "";
        r.mobil ??= "";
        r.strasse ??= "";
        r.plz ??= "";
        r.ort ??= "";
        r.land ??= "DE";
        r.rolleFrei ??= "";
        r.favorit ??= false;
        r.onlineAbschluss ??= false;
        r.optin ??= false;

        r.gesamtZiel ??= ""; r.gesamtIst ??= "";
        r.vollZiel ??= ""; r.vollIst ??= "";
        r.beihilfeZiel ??= ""; r.beihilfeIst ??= "";
        r.zusatzZiel ??= ""; r.zusatzIst ??= "";
        r.pflegeZiel ??= ""; r.pflegeIst ??= "";
        r.bkvZiel ??= ""; r.bkvIst ??= "";
        r.reiseZiel ??= ""; r.reiseIst ??= "";

        r.prodVoll ??= ""; r.zielVoll ??= "";
        r.prodBeihilfe ??= ""; r.zielBeihilfe ??= "";
        r.prodZusatz ??= ""; r.zielZusatz ??= "";
        r.prodBkv ??= ""; r.zielBkv ??= "";

        if(!p.hasMak) r.makNummer = undefined;
        r.partnerNummer ??= "";
        r.datum ??= todayISO();
      }
    }

    db.ui ||= {};
    db.ui.activePartnerKey ||= PARTNERS[0].key;
    db.ui.q ||= "";
    db.ui.allPartners ||= false;
    db.ui.onlyOpen ||= false;
    db.ui.onlyYear ||= false;
    db.ui.year ||= currentYear();
  }

  function saveDB(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
  }

  function setStatus(text){
    $("statusPill").textContent = text;
  }

  function touch(rec){
    rec.updatedAt = new Date().toISOString();
    saveDB(); // robust: immer speichern, damit nichts verloren geht
    setStatus("gespeichert");
    setTimeout(()=> setStatus("bereit"), 800);
  }

  // ===============================
  // Active selectors
  // ===============================
  function getActivePartner(){
    return PARTNERS.find(p => p.key === db.ui.activePartnerKey) || PARTNERS[0];
  }
  function getPartnerState(key){
    return db.partners[key];
  }
  function getActiveRecord(){
    const p = getActivePartner();
    const ps = getPartnerState(p.key);
    const r = ps.records.find(x => x.id === ps.activeRecordId) || ps.records[0];
    ps.activeRecordId = r.id;
    return r;
  }

  // ===============================
  // UI builders
  // ===============================
  function inputField({ id, label, type="text", value="", placeholder="", span="w4", attrs={} }){
    const wrap = document.createElement("div");
    wrap.className = `field ${span}`;

    const lab = document.createElement("label");
    lab.textContent = label;
    lab.htmlFor = id;

    let el;
    if(type === "textarea"){
      el = document.createElement("textarea");
    }else{
      el = document.createElement("input");
      el.type = type;
    }
    el.id = id;
    el.placeholder = placeholder;
    el.value = value ?? "";
    for(const [k,v] of Object.entries(attrs || {})){
      el.setAttribute(k, v);
    }

    wrap.appendChild(lab);
    wrap.appendChild(el);

    return { wrap, el };
  }

  function checkboxField({ id, label, checked=false, span="w4" }){
    const wrap = document.createElement("div");
    wrap.className = `field ${span}`;
    const lab = document.createElement("label");
    lab.textContent = label;

    const el = document.createElement("input");
    el.type = "checkbox";
    el.id = id;
    el.checked = !!checked;
    el.style.height = "18px";
    el.style.width = "18px";

    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.gap = "10px";
    row.style.alignItems = "center";
    row.appendChild(el);
    row.appendChild(lab);

    wrap.appendChild(document.createElement("div")).appendChild(row);
    return { wrap, el };
  }

  function selectField({ id, label, options=[], value="", span="w4" }){
    const wrap = document.createElement("div");
    wrap.className = `field ${span}`;

    const lab = document.createElement("label");
    lab.textContent = label;
    lab.htmlFor = id;

    const sel = document.createElement("select");
    sel.id = id;

    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "‚Äî";
    sel.appendChild(opt0);

    for(const o of options){
      const opt = document.createElement("option");
      opt.value = o;
      opt.textContent = o;
      sel.appendChild(opt);
    }
    sel.value = value || "";

    wrap.appendChild(lab);
    wrap.appendChild(sel);
    return { wrap, sel };
  }

  // ===============================
  // Record label (Reiter)
  // ===============================
  function recordLabel(partner, r, idx){
    const role = ((r.rolleFrei || r.rolle) || "").trim() || "ohne Rolle";
    const mak = partner.hasMak ? (r.makNummer || "").trim() : "";
    const fav = r.favorit ? " ‚òÖ" : "";
    const makPart = mak ? ` ¬∑ MAK ${mak}` : "";
    return `Reiter ${idx+1} ‚Äì ${role}${makPart}${fav}`;
  }

  // ===============================
  // Search
  // ===============================
  function normalize(s){ return (s ?? "").toString().toLowerCase().trim(); }

  function recordSearchText(partner, r){
    const kontaktParts = [];
    if(Array.isArray(r.kontakte)){
      for(const k of r.kontakte){
        kontaktParts.push(k.datum, k.anlass, k.notiz, k.followUpDatum, k.followUpThema, k.followUpErledigt ? "erledigt" : "offen");
      }
    }
    return [
      partner.name,
      r.name, r.firma, r.email, r.mobil, r.telefon,
      r.strasse, r.plz, r.ort, r.land,
      r.rolle, r.rolleFrei,
      r.makNummer, r.partnerNummer,
      r.freiesFeld,
      ...kontaktParts
    ].map(normalize).join(" | ");
  }

  function getSearchHits(){
    const q = normalize(db.ui.q);
    const hits = [];
    const partnersToSearch = db.ui.allPartners ? PARTNERS : [getActivePartner()];

    for(const p of partnersToSearch){
      const ps = getPartnerState(p.key);
      for(const r of ps.records){
        if(db.ui.onlyOpen){
          const openFU = (r.kontakte || []).some(k => k.followUpDatum && !k.followUpErledigt);
          if(!openFU) continue;
        }
        if(q){
          const hay = recordSearchText(p, r);
          if(!hay.includes(q)) continue;
        }
        hits.push({ partner:p, record:r });
      }
    }
    return hits;
  }

  // ===============================
  // Monthly buckets (from Jahreswerte gleichm√§√üig /12)
  // ===============================
  function monthlyBuckets(){
    const p = getActivePartner();
    const ps = getPartnerState(p.key);
    const y = parseInt($("yearSelect").value,10) || currentYear();

    const buckets = Array.from({length:12}, () => ({
      prodVoll:0, zielVoll:0,
      prodBeihilfe:0, zielBeihilfe:0,
      prodZusatz:0, zielZusatz:0,
      prodBkv:0, zielBkv:0
    }));

    for(const r of ps.records){
      if(yearFromISO(r.datum) !== y) continue;

      // Jahreswerte /12 verteilen
      const mProdVoll = moneyParse(r.prodVoll)/12;
      const mZielVoll = moneyParse(r.zielVoll)/12;

      const mProdBeihilfe = moneyParse(r.prodBeihilfe)/12;
      const mZielBeihilfe = moneyParse(r.zielBeihilfe)/12;

      const mProdZusatz = moneyParse(r.prodZusatz)/12;
      const mZielZusatz = moneyParse(r.zielZusatz)/12;

      const mProdBkv = moneyParse(r.prodBkv)/12;
      const mZielBkv = moneyParse(r.zielBkv)/12;

      for(let mi=0; mi<12; mi++){
        const b = buckets[mi];
        b.prodVoll += mProdVoll;     b.zielVoll += mZielVoll;
        b.prodBeihilfe += mProdBeihilfe; b.zielBeihilfe += mZielBeihilfe;
        b.prodZusatz += mProdZusatz; b.zielZusatz += mZielZusatz;
        b.prodBkv += mProdBkv;       b.zielBkv += mZielBkv;
      }
    }
    return buckets;
  }

  function buildYearCsv(){
    const months = ["Jan","Feb","M√§r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];
    const buckets = monthlyBuckets();
    let csv = "Monat;Prod Voll;Ziel Voll;Prod Beihilfe;Ziel Beihilfe;Prod Zusatz;Ziel Zusatz;Prod bKV;Ziel bKV;Gesamt Prod;Gesamt Ziel\n";
    for(let i=0;i<12;i++){
      const b = buckets[i];
      const prodGes = b.prodVoll + b.prodBeihilfe + b.prodZusatz + b.prodBkv;
      const zielGes = b.zielVoll + b.zielBeihilfe + b.zielZusatz + b.zielBkv;
      csv += [
        months[i],
        moneyFmt(b.prodVoll), moneyFmt(b.zielVoll),
        moneyFmt(b.prodBeihilfe), moneyFmt(b.zielBeihilfe),
        moneyFmt(b.prodZusatz), moneyFmt(b.zielZusatz),
        moneyFmt(b.prodBkv), moneyFmt(b.zielBkv),
        moneyFmt(prodGes), moneyFmt(zielGes)
      ].join(";") + "\n";
    }
    return csv;
  }

  function renderYearTable(){
    const buckets = monthlyBuckets();
    const months = ["Jan","Feb","M√§r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];

    const table = $("yearTable");
    table.innerHTML = "";

    const thead = document.createElement("thead");
    const trh = document.createElement("tr");
    const headers = ["Monat","Prod Voll","Ziel Voll","%","Prod Beihilfe","Ziel Beihilfe","%","Prod Zusatz","Ziel Zusatz","%","Prod bKV","Ziel bKV","%","Gesamt Prod","Gesamt Ziel","%"];
    for(const h of headers){
      const th = document.createElement("th");
      th.textContent = h;
      trh.appendChild(th);
    }
    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    for(let i=0;i<12;i++){
      const b = buckets[i];
      const tr = document.createElement("tr");

      const prodGes = b.prodVoll + b.prodBeihilfe + b.prodZusatz + b.prodBkv;
      const zielGes = b.zielVoll + b.zielBeihilfe + b.zielZusatz + b.zielBkv;

      const pct = (p,z)=> z>0 ? Math.round((p/z)*100) : 0;

      const cells = [
        months[i],
        moneyFmt(b.prodVoll), moneyFmt(b.zielVoll), pct(b.prodVoll,b.zielVoll)+"%",
        moneyFmt(b.prodBeihilfe), moneyFmt(b.zielBeihilfe), pct(b.prodBeihilfe,b.zielBeihilfe)+"%",
        moneyFmt(b.prodZusatz), moneyFmt(b.zielZusatz), pct(b.prodZusatz,b.zielZusatz)+"%",
        moneyFmt(b.prodBkv), moneyFmt(b.zielBkv), pct(b.prodBkv,b.zielBkv)+"%",
        moneyFmt(prodGes), moneyFmt(zielGes), pct(prodGes,zielGes)+"%"
      ];

      for(const c of cells){
        const td = document.createElement("td");
        td.textContent = c;
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
  }

  // ===============================
  // Dashboard: open followups + ampel
  // ===============================
  function getOpenFollowups(){
    const out = [];
    const partnersToSearch = db.ui.allPartners ? PARTNERS : [getActivePartner()];
    for(const p of partnersToSearch){
      const ps = getPartnerState(p.key);
      for(const r of ps.records){
        for(const k of (r.kontakte || [])){
          if(k.followUpDatum && !k.followUpErledigt){
            if(db.ui.onlyYear){
              const y = parseInt($("yearSelect").value,10) || currentYear();
              if(yearFromISO(k.followUpDatum) !== y) continue;
            }
            out.push({ partner:p, record:r, kontakt:k });
          }
        }
      }
    }
    // sort by followUpDate
    out.sort((a,b)=> String(a.kontakt.followUpDatum).localeCompare(String(b.kontakt.followUpDatum)));
    return out;
  }

  function computeAmpel(rec){
    // simple: based on Gesamt Ist vs Gesamt Ziel if filled, else based on Monats % (from prod/ziele)
    const ziel = moneyParse(rec.gesamtZiel);
    const ist = moneyParse(rec.gesamtIst);
    if(ziel > 0){
      const pct = ist / ziel;
      if(pct >= 0.95) return "gr√ºn";
      if(pct >= 0.7) return "gelb";
      return "rot";
    }
    const z = moneyParse(rec.zielVoll)+moneyParse(rec.zielBeihilfe)+moneyParse(rec.zielZusatz)+moneyParse(rec.zielBkv);
    const p = moneyParse(rec.prodVoll)+moneyParse(rec.prodBeihilfe)+moneyParse(rec.prodZusatz)+moneyParse(rec.prodBkv);
    if(z > 0){
      const pct = p / z;
      if(pct >= 0.95) return "gr√ºn";
      if(pct >= 0.7) return "gelb";
      return "rot";
    }
    return "‚Äî";
  }

  function renderDashboard(){
    const open = getOpenFollowups();
    $("openCount").textContent = open.length;

    if(open.length === 0){
      $("openList").innerHTML = "<span class='muted'>‚Äî keine offenen Wiedervorlagen</span>";
    }else{
      const lines = open.slice(0,10).map(o => {
        const role = ((o.record.rolleFrei || o.record.rolle) || "ohne Rolle").trim();
        const who = (o.record.name || o.record.firma || "ohne Name").trim();
        const when = o.kontakt.followUpDatum;
        const what = o.kontakt.followUpThema || o.kontakt.anlass || "‚Äî";
        return `<div style="margin:4px 0;">
          <strong>${when}</strong> ¬∑ <span style="color:var(--pf-main); font-weight:900;">${o.partner.name}</span> ¬∑ ${role} ¬∑ ${escapeHtml(who)}
          <div class="small muted">${escapeHtml(what)}</div>
        </div>`;
      }).join("");
      const more = open.length > 10 ? `<div class="small muted" style="margin-top:6px;">+ ${open.length-10} weitere ‚Ä¶</div>` : "";
      $("openList").innerHTML = lines + more;
    }

    // left chips
    const rec = getActiveRecord();
    $("favText").textContent = rec.favorit ? "Ja" : "Nein";
    const am = computeAmpel(rec);
    $("ampelText").textContent = am;
    const chipA = $("chipAmpel");
    chipA.classList.remove("ok","warn","bad");
    if(am==="gr√ºn") chipA.classList.add("ok");
    if(am==="gelb") chipA.classList.add("warn");
    if(am==="rot") chipA.classList.add("bad");
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  // ===============================
  // Render: partner tabs + record select + form
  // ===============================
  function renderPartnerTabs(){
    const wrap = $("partnerTabs");
    wrap.innerHTML = "";
    for(const p of PARTNERS){
      const el = document.createElement("div");
      el.className = "tab" + (db.ui.activePartnerKey===p.key ? " active":"");
      el.textContent = p.name;
      el.onclick = () => {
        db.ui.activePartnerKey = p.key;
        saveDB();
        renderAll();
      };
      wrap.appendChild(el);
    }
  }

  function renderRecordSelect(){
    const partner = getActivePartner();
    const ps = getPartnerState(partner.key);
    const sel = $("recordSelect");
    sel.innerHTML = "";
    ps.records.forEach((r, idx) => {
      const opt = document.createElement("option");
      opt.value = r.id;
      opt.textContent = recordLabel(partner, r, idx);
      if(r.id === ps.activeRecordId) opt.selected = true;
      sel.appendChild(opt);
    });
    sel.onchange = () => {
      ps.activeRecordId = sel.value;
      saveDB();
      renderAll();
    };
  }

  function renderRoleCustomInfo(){
    const p = getActivePartner();
    const ps = getPartnerState(p.key);
    const list = ps.roleCustom || [];
    $("roleCustomInfo").textContent = list.length ? ("Aktuelle Zusatz-Rollen: " + list.join(", ")) : "Noch keine Zusatz-Rollen gespeichert.";
  }

  function renderHits(){
    const hits = getSearchHits();
    $("hitBadge").textContent = `${hits.length} Treffer`;

    const card = $("hitsCard");
    card.innerHTML = "";
    if(hits.length === 0){
      card.innerHTML = `<div class="small muted">Keine Treffer.</div>`;
      return;
    }

    const tbl = document.createElement("table");
    const thead = document.createElement("thead");
    thead.innerHTML = `<tr>
      <th>Partner</th><th>Reiter</th><th>Name/Firma</th><th>Rolle</th><th>MAK</th><th>Wiedervorlage</th>
    </tr>`;
    tbl.appendChild(thead);

    const tbody = document.createElement("tbody");
    hits.slice(0,100).forEach(h => {
      const p = h.partner;
      const ps = getPartnerState(p.key);
      const idx = ps.records.findIndex(x => x.id === h.record.id);
      const role = (h.record.rolleFrei || h.record.rolle || "").trim();
      const mak = p.hasMak ? (h.record.makNummer || "") : "";
      const who = (h.record.name || h.record.firma || "‚Äî");
      const next = (h.record.kontakte || []).find(k => k.followUpDatum && !k.followUpErledigt);
      const wv = next ? `${next.followUpDatum} ‚Äì ${next.followUpThema || next.anlass || ""}` : "‚Äî";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(p.name)}</td>
        <td>${idx>=0 ? (idx+1) : "‚Äî"}</td>
        <td>${escapeHtml(who)}</td>
        <td>${escapeHtml(role)}</td>
        <td>${escapeHtml(mak)}</td>
        <td>${escapeHtml(wv)}</td>
      `;
      tr.style.cursor = "pointer";
      tr.onclick = () => {
        db.ui.activePartnerKey = p.key;
        ps.activeRecordId = h.record.id;
        saveDB();
        renderAll();
        $("hitsCard").style.display = "none";
      };
      tbody.appendChild(tr);
    });
    tbl.appendChild(tbody);
    card.appendChild(tbl);

    if(hits.length > 100){
      const info = document.createElement("div");
      info.className = "small muted";
      info.style.marginTop = "8px";
      info.textContent = `Hinweis: Anzeige auf 100 Treffer begrenzt (insgesamt ${hits.length}).`;
      card.appendChild(info);
    }
  }

  function renderForm(){
    const partner = getActivePartner();
    const ps = getPartnerState(partner.key);
    const rec = getActiveRecord();

    document.body.setAttribute("data-partner", partner.key);
    $("activePartnerBadge").textContent = partner.name;

    const form = $("form");
    form.innerHTML = "";

    // Row: role + mak (instead of date/partner shown as primary)
    const r1 = document.createElement("div"); r1.className = "row";

    const roleOptionsBase = (partner.roleType === "fonds") ? ROLE_DROPDOWN_FONDS : ROLE_DROPDOWN_ACCOUNT;
    const roleOptions = [...roleOptionsBase, ...(ps.roleCustom || [])];

    const fRole = selectField({ id:"rolle", label:"Rolle (Standard)", options: roleOptions, value: rec.rolle || "", span:"w6" });
    r1.appendChild(fRole.wrap);

    const fRoleFree = inputField({ id:"rolleFrei", label:"Rolle (frei)", value: rec.rolleFrei || "", placeholder:"eigene Rolle eintragen ‚Ä¶", span:"w6" });
    r1.appendChild(fRoleFree.wrap);

    fRole.sel.onchange = () => { rec.rolle = fRole.sel.value; touch(rec); renderRecordSelect(); renderDashboard(); };
    fRoleFree.el.oninput = () => { rec.rolleFrei = fRoleFree.el.value; touch(rec); renderRecordSelect(); renderDashboard(); };

    form.appendChild(r1);

    const r1b = document.createElement("div"); r1b.className = "row";
    if(partner.hasMak){
      const fMak = inputField({ id:"makNummer", label:"MAK-Nummer", value: rec.makNummer || "", placeholder:"MAK ‚Ä¶", span:"w6" });
      r1b.appendChild(fMak.wrap);
      fMak.el.oninput = () => { rec.makNummer = fMak.el.value; touch(rec); renderRecordSelect(); };
    }else{
      const spacer = document.createElement("div");
      spacer.className = "field w6";
      r1b.appendChild(spacer);
    }

    const fDatum = inputField({ id:"datum", label:"Datum (f√ºr Jahres-/Monatslogik)", type:"date", value: rec.datum || todayISO(), span:"w6" });
    r1b.appendChild(fDatum.wrap);
    fDatum.el.onchange = () => { rec.datum = fDatum.el.value; touch(rec); renderYearTable(); renderDashboard(); };

    form.appendChild(r1b);

    // Stammdaten (breit, kopierbar)
    const stammdatenBox = document.createElement("div");
    stammdatenBox.className = "stammdatenBox";

    const title = document.createElement("div");
    title.className = "stammdatenTitle";
    title.innerHTML = `<div class="tag">Stammdaten</div><div class="small muted">Name ¬∑ Firma ¬∑ E-Mail ¬∑ Mobil/Telefon ¬∑ Adresse</div>`;
    stammdatenBox.appendChild(title);

    const r2 = document.createElement("div"); r2.className = "row";
    const fName = inputField({ id:"name", label:"Name", value: rec.name || "", placeholder:"Vor- und Nachname", span:"w12" });
    const fFirma = inputField({ id:"firma", label:"Firma", value: rec.firma || "", placeholder:"Firmenname", span:"w12" });
    const fEmail = inputField({ id:"email", label:"E-Mail", type:"email", value: rec.email || "", placeholder:"name@firma.de", span:"w12" });
    r2.appendChild(fName.wrap); r2.appendChild(fFirma.wrap); r2.appendChild(fEmail.wrap);
    fName.el.oninput = () => { rec.name = fName.el.value; touch(rec); renderRecordSelect(); };
    fFirma.el.oninput = () => {
      rec.firma = fFirma.el.value;
      const filled = applyAddressAutofill(rec);
      touch(rec);
      renderRecordSelect();
      if(filled) renderForm(); // refresh to show autofilled fields
    };
    fEmail.el.oninput = () => { rec.email = fEmail.el.value; touch(rec); };
    stammdatenBox.appendChild(r2);

    const r2b = document.createElement("div"); r2b.className = "row";
    const fMobil = inputField({ id:"mobil", label:"Mobil", type:"tel", value: rec.mobil || "", placeholder:"+49 ‚Ä¶", span:"w6" });
    const fTel = inputField({ id:"telefon", label:"Telefon", type:"tel", value: rec.telefon || "", placeholder:"z. B. 0711 ‚Ä¶", span:"w6" });
    r2b.appendChild(fMobil.wrap); r2b.appendChild(fTel.wrap);
    fMobil.el.oninput = () => { rec.mobil = fMobil.el.value; touch(rec); };
    fTel.el.oninput = () => { rec.telefon = fTel.el.value; touch(rec); };
    stammdatenBox.appendChild(r2b);

    const r2c = document.createElement("div"); r2c.className = "row";
    const fStr = inputField({ id:"strasse", label:"Stra√üe", value: rec.strasse || "", placeholder:"Stra√üe + Nr.", span:"w6" });
    const fPlz = inputField({ id:"plz", label:"PLZ", value: rec.plz || "", placeholder:"12345", span:"w2" });
    const fOrt = inputField({ id:"ort", label:"Ort", value: rec.ort || "", placeholder:"Ort", span:"w4" });
    r2c.appendChild(fStr.wrap); r2c.appendChild(fPlz.wrap); r2c.appendChild(fOrt.wrap);
    fStr.el.oninput = () => { rec.strasse = fStr.el.value; touch(rec); };
    fPlz.el.oninput = () => { rec.plz = fPlz.el.value; touch(rec); };
    fOrt.el.oninput = () => { rec.ort = fOrt.el.value; touch(rec); };
    stammdatenBox.appendChild(r2c);

    form.appendChild(stammdatenBox);

    // Optin + Online Abschluss (au√üerhalb Stammdaten)
    const r3 = document.createElement("div"); r3.className = "row";
    const fOptin = checkboxField({ id:"optin", label:"Optin (Einwilligung liegt vor)", checked: !!rec.optin, span:"w6" });
    const fOnline = checkboxField({ id:"onlineAbschluss", label:"Online Abschluss", checked: !!rec.onlineAbschluss, span:"w6" });
    r3.appendChild(fOptin.wrap);
    r3.appendChild(fOnline.wrap);
    fOptin.el.onchange = () => { rec.optin = fOptin.el.checked; touch(rec); };
    fOnline.el.onchange = () => { rec.onlineAbschluss = fOnline.el.checked; touch(rec); renderDashboard(); };
    form.appendChild(r3);

    // Favorit
    const rFav = document.createElement("div"); rFav.className = "row";
    const fFav = checkboxField({ id:"favorit", label:"Favorit", checked: !!rec.favorit, span:"w6" });
    rFav.appendChild(fFav.wrap);
    const spacer2 = document.createElement("div"); spacer2.className = "field w6";
    rFav.appendChild(spacer2);
    fFav.el.onchange = () => { rec.favorit = fFav.el.checked; touch(rec); renderRecordSelect(); renderDashboard(); };
    form.appendChild(rFav);

    // Freies Feld
    const rFree = document.createElement("div"); rFree.className = "row";
    const fFree = inputField({ id:"freiesFeld", label:"Freies Feld", type:"textarea", value: rec.freiesFeld || "", placeholder:"Notizen ‚Ä¶", span:"w12" });
    rFree.appendChild(fFree.wrap);
    fFree.el.oninput = () => { rec.freiesFeld = fFree.el.value; touch(rec); };
    form.appendChild(rFree);

    // Jahres√ºbersicht (manuell) Ziel/Ist
    form.appendChild(dividerEl());
    const hY = document.createElement("div");
    hY.className = "h2";
    hY.textContent = "Gesamtproduktion (Jahr) ‚Äì Ziel & Ist (‚Ç¨)";
    form.appendChild(hY);

    const mkY = (id,label,val,span="w3") =>
      inputField({ id, label, value: val || "", placeholder:"‚Ç¨", span, attrs:{ inputmode:"decimal" } });

    const y1 = document.createElement("div"); y1.className = "row";
    const gZ = mkY("gesamtZiel","Gesamt Ziel",rec.gesamtZiel,"w6");
    const gI = mkY("gesamtIst","Gesamt Ist",rec.gesamtIst,"w6");
    y1.appendChild(gZ.wrap); y1.appendChild(gI.wrap);
    form.appendChild(y1);

    const y2 = document.createElement("div"); y2.className = "row";
    const vZ = mkY("vollZiel","Voll Ziel",rec.vollZiel);
    const vI = mkY("vollIst","Voll Ist",rec.vollIst);
    const bZ = mkY("beihilfeZiel","Beihilfe Ziel",rec.beihilfeZiel);
    const bI = mkY("beihilfeIst","Beihilfe Ist",rec.beihilfeIst);
    y2.appendChild(vZ.wrap); y2.appendChild(vI.wrap); y2.appendChild(bZ.wrap); y2.appendChild(bI.wrap);
    form.appendChild(y2);

    const y3 = document.createElement("div"); y3.className = "row";
    const zZ = mkY("zusatzZiel","Zusatz Ziel",rec.zusatzZiel);
    const zI = mkY("zusatzIst","Zusatz Ist",rec.zusatzIst);
    const pZ = mkY("pflegeZiel","Pflege Ziel",rec.pflegeZiel);
    const pI = mkY("pflegeIst","Pflege Ist",rec.pflegeIst);
    y3.appendChild(zZ.wrap); y3.appendChild(zI.wrap); y3.appendChild(pZ.wrap); y3.appendChild(pI.wrap);
    form.appendChild(y3);

    const y4 = document.createElement("div"); y4.className = "row";
    const kZ = mkY("bkvZiel","bKV Ziel",rec.bkvZiel);
    const kI = mkY("bkvIst","bKV Ist",rec.bkvIst);
    const rZ = mkY("reiseZiel","Reise Ziel",rec.reiseZiel);
    const rI = mkY("reiseIst","Reise Ist",rec.reiseIst);
    y4.appendChild(kZ.wrap); y4.appendChild(kI.wrap); y4.appendChild(rZ.wrap); y4.appendChild(rI.wrap);
    form.appendChild(y4);

    function onYearManual(){
      touch(rec);
      renderDashboard();
    }
    [gZ,gI,vZ,vI,bZ,bI,zZ,zI,pZ,pI,kZ,kI,rZ,rI].forEach(f=>{
      f.el.oninput = () => { rec[f.el.id] = f.el.value; onYearManual(); };
    });

    // Produktion & Ziele (Jahreswerte f√ºr Monats√ºbersicht)
    form.appendChild(dividerEl());
    const hP = document.createElement("div");
    hP.className = "h2";
    hP.textContent = "Produktion & Ziele (Jahreswerte ‚Üí Monats√ºbersicht)";
    form.appendChild(hP);

    const rP = document.createElement("div"); rP.className = "row";
    const pv = inputField({ id:"prodVoll", label:"Produktion Voll", value: rec.prodVoll || "", placeholder:"‚Ç¨", span:"w3", attrs:{inputmode:"decimal"} });
    const zv = inputField({ id:"zielVoll", label:"Ziel Voll", value: rec.zielVoll || "", placeholder:"‚Ç¨", span:"w3", attrs:{inputmode:"decimal"} });
    const pb = inputField({ id:"prodBeihilfe", label:"Produktion Beihilfe", value: rec.prodBeihilfe || "", placeholder:"‚Ç¨", span:"w3", attrs:{inputmode:"decimal"} });
    const zb = inputField({ id:"zielBeihilfe", label:"Ziel Beihilfe", value: rec.zielBeihilfe || "", placeholder:"‚Ç¨", span:"w3", attrs:{inputmode:"decimal"} });
    const pz = inputField({ id:"prodZusatz", label:"Produktion Zusatz", value: rec.prodZusatz || "", placeholder:"‚Ç¨", span:"w3", attrs:{inputmode:"decimal"} });
    const zz = inputField({ id:"zielZusatz", label:"Ziel Zusatz", value: rec.zielZusatz || "", placeholder:"‚Ç¨", span:"w3", attrs:{inputmode:"decimal"} });
    const pk = inputField({ id:"prodBkv", label:"Produktion bKV", value: rec.prodBkv || "", placeholder:"‚Ç¨", span:"w3", attrs:{inputmode:"decimal"} });
    const zk = inputField({ id:"zielBkv", label:"Ziel bKV", value: rec.zielBkv || "", placeholder:"‚Ç¨", span:"w3", attrs:{inputmode:"decimal"} });
    [pv,zv,pb,zb,pz,zz,pk,zk].forEach(x => rP.appendChild(x.wrap));
    form.appendChild(rP);

    function onMoney(){
      touch(rec);
      renderDashboard();
      renderYearTable();
      renderRecordSelect();
    }
    pv.el.oninput=()=>{ rec.prodVoll=pv.el.value; onMoney(); };
    zv.el.oninput=()=>{ rec.zielVoll=zv.el.value; onMoney(); };
    pb.el.oninput=()=>{ rec.prodBeihilfe=pb.el.value; onMoney(); };
    zb.el.oninput=()=>{ rec.zielBeihilfe=zb.el.value; onMoney(); };
    pz.el.oninput=()=>{ rec.prodZusatz=pz.el.value; onMoney(); };
    zz.el.oninput=()=>{ rec.zielZusatz=zz.el.value; onMoney(); };
    pk.el.oninput=()=>{ rec.prodBkv=pk.el.value; onMoney(); };
    zk.el.oninput=()=>{ rec.zielBkv=zk.el.value; onMoney(); };

    // Kontakte + Wiedervorlagen (je Kontakt)
    form.appendChild(dividerEl());
    const hK = document.createElement("div");
    hK.className = "h2";
    hK.textContent = "Kontakt 1 und fortlaufend (inkl. Wiedervorlage / Follow-up)";
    form.appendChild(hK);

    const kWrap = document.createElement("div");
    (rec.kontakte || []).forEach((k, idx) => {
      const box = document.createElement("div");
      box.className = "card";
      box.style.boxShadow = "none";
      box.style.borderRadius = "16px";
      box.style.margin = "10px 0";
      box.style.padding = "14px";

      const top = document.createElement("div");
      top.className = "row";
      const title = document.createElement("div");
      title.className = "h2";
      title.style.margin = "0";
      title.textContent = `Kontakt ${idx+1}`;
      top.appendChild(title);

      const btns = document.createElement("div");
      btns.style.marginLeft = "auto";
      btns.style.display = "flex";
      btns.style.gap = "8px";

      const btnDel = document.createElement("button");
      btnDel.className = "danger ghost no-print";
      btnDel.textContent = "Kontakt l√∂schen";
      btnDel.disabled = rec.kontakte.length <= 1;
      btnDel.onclick = () => {
        rec.kontakte = rec.kontakte.filter(x => x.id !== k.id);
        touch(rec);
        renderAll();
      };
      btns.appendChild(btnDel);
      top.appendChild(btns);

      box.appendChild(top);

      const rK1 = document.createElement("div"); rK1.className = "row";
      const kd = inputField({ id:`k_${k.id}_datum`, label:"Kontakt-Datum", type:"date", value: k.datum || "", span:"w4" });
      const ka = inputField({ id:`k_${k.id}_anlass`, label:"Anlass", value: k.anlass || "", placeholder:"z. B. Jahresgespr√§ch", span:"w4" });
      const kn = inputField({ id:`k_${k.id}_notiz`, label:"Notiz", value: k.notiz || "", placeholder:"Kurznotiz ‚Ä¶", span:"w4" });
      rK1.appendChild(kd.wrap); rK1.appendChild(ka.wrap); rK1.appendChild(kn.wrap);
      box.appendChild(rK1);

      const rK2 = document.createElement("div"); rK2.className = "row";
      const fuD = inputField({ id:`k_${k.id}_fud`, label:"Wiedervorlage (Datum)", type:"date", value: k.followUpDatum || "", span:"w4" });
      const fuT = inputField({ id:`k_${k.id}_fut`, label:"Wiedervorlage (Thema)", value: k.followUpThema || "", placeholder:"Thema / ToDo ‚Ä¶", span:"w6" });
      const fuE = checkboxField({ id:`k_${k.id}_fue`, label:"Wiedervorlage erledigt", checked: !!k.followUpErledigt, span:"w2" });
      rK2.appendChild(fuD.wrap); rK2.appendChild(fuT.wrap); rK2.appendChild(fuE.wrap);
      box.appendChild(rK2);

      kd.el.onchange = () => { k.datum = kd.el.value; touch(rec); renderDashboard(); };
      ka.el.oninput  = () => { k.anlass = ka.el.value; touch(rec); renderDashboard(); };
      kn.el.oninput  = () => { k.notiz  = kn.el.value; touch(rec); renderDashboard(); };

      fuD.el.onchange = () => { k.followUpDatum = fuD.el.value; touch(rec); renderDashboard(); renderHits(); };
      fuT.el.oninput  = () => { k.followUpThema = fuT.el.value; touch(rec); renderDashboard(); renderHits(); };
      fuE.el.onchange = () => { k.followUpErledigt = fuE.el.checked; touch(rec); renderDashboard(); renderHits(); };

      kWrap.appendChild(box);
    });

    const addK = document.createElement("button");
    addK.className = "ghost no-print";
    addK.textContent = "+ Kontakt hinzuf√ºgen";
    addK.onclick = () => {
      rec.kontakte.push({ id: uid(), datum: todayISO(), anlass:"", notiz:"", followUpDatum:"", followUpThema:"", followUpErledigt:false });
      touch(rec);
      renderAll();
    };
    form.appendChild(kWrap);
    form.appendChild(addK);

    // Zusatzfelder (Custom)
    if(ps.customFields.length){
      form.appendChild(dividerEl());
      const hc = document.createElement("div");
      hc.className = "h2";
      hc.textContent = "Zusatzfelder (Custom)";
      form.appendChild(hc);

      const rc = document.createElement("div"); rc.className = "row";
      for(const cf of ps.customFields){
        const id = "cf_" + cf.id;
        const type = cf.type;
        let f;
        if(type === "checkbox"){
          f = checkboxField({ id, label: cf.label, checked: !!rec.custom[cf.id], span:"w3" });
          f.el.onchange = () => { rec.custom[cf.id] = f.el.checked; touch(rec); };
        }else if(type === "textarea"){
          f = inputField({ id, label: cf.label, type:"textarea", value: rec.custom[cf.id] || "", span:"w12" });
          f.el.oninput = () => { rec.custom[cf.id] = f.el.value; touch(rec); };
        }else{
          f = inputField({ id, label: cf.label, value: rec.custom[cf.id] || "", span:"w4" });
          f.el.oninput = () => { rec.custom[cf.id] = f.el.value; touch(rec); };
        }
        rc.appendChild(f.wrap);
      }
      form.appendChild(rc);
    }

    // update chips buttons (call/mail/copy)
    wireQuickActions(rec);
  }

  function dividerEl(){
    const d = document.createElement("div");
    d.className = "divider";
    return d;
  }

  function wireQuickActions(rec){
    $("chipFavorite").onclick = () => {
      rec.favorit = !rec.favorit;
      touch(rec);
      renderRecordSelect();
      renderDashboard();
    };

    $("btnCopyAddress").onclick = () => {
      const addr = [rec.firma, rec.strasse, `${rec.plz} ${rec.ort}`.trim()].filter(Boolean).join("\n");
      copyToClipboard(addr);
      setStatus("Adresse kopiert");
      setTimeout(()=>setStatus("bereit"),700);
    };
    $("btnCopyPhone").onclick = () => {
      const s = [rec.telefon ? ("Tel: " + rec.telefon) : "", rec.mobil ? ("Mobil: " + rec.mobil) : ""].filter(Boolean).join("\n");
      copyToClipboard(s);
      setStatus("Telefon kopiert");
      setTimeout(()=>setStatus("bereit"),700);
    };
    $("btnCall").onclick = () => {
      const num = (rec.mobil || rec.telefon || "").trim();
      if(!num) return alert("Keine Telefonnummer vorhanden.");
      window.location.href = `tel:${num.replace(/\s+/g,"")}`;
    };
    $("btnMail").onclick = () => {
      const mail = (rec.email || "").trim();
      if(!mail) return alert("Keine E-Mail vorhanden.");
      window.location.href = `mailto:${mail}`;
    };
  }

  // ===============================
  // Actions: records, custom fields, export/import, etc.
  // ===============================
  function newRecord(){
    const p = getActivePartner();
    const ps = getPartnerState(p.key);
    const r = baseRecord(p);
    ps.records.push(r);
    ps.activeRecordId = r.id;
    saveDB();
    renderAll();
  }

  function deleteRecord(){
    const p = getActivePartner();
    const ps = getPartnerState(p.key);
    if(ps.records.length <= 1) return alert("Mindestens ein Reiter muss bestehen.");
    const r = getActiveRecord();
    if(!confirm("Diesen Reiter wirklich l√∂schen?")) return;
    ps.records = ps.records.filter(x => x.id !== r.id);
    ps.activeRecordId = ps.records[0].id;
    saveDB();
    renderAll();
  }

  function addCustomField(){
    const p = getActivePartner();
    const ps = getPartnerState(p.key);
    const label = prompt("Name des neuen Feldes?");
    if(!label) return;

    const type = prompt("Typ: text | textarea | checkbox", "text") || "text";
    const t = ["text","textarea","checkbox"].includes(type) ? type : "text";

    ps.customFields.push({ id: uid(), label, type:t });
    saveDB();
    renderAll();
  }

  function deleteCustomField(){
    const p = getActivePartner();
    const ps = getPartnerState(p.key);
    if(ps.customFields.length === 0) return alert("Keine Custom-Felder vorhanden.");
    const names = ps.customFields.map((f,i)=>`${i+1}: ${f.label} (${f.type})`).join("\n");
    const idx = prompt("Welches Feld l√∂schen? Nummer eingeben:\n\n" + names);
    if(!idx) return;
    const n = parseInt(idx,10);
    if(!Number.isFinite(n) || n<1 || n>ps.customFields.length) return alert("Ung√ºltige Nummer.");
    const f = ps.customFields[n-1];
    if(!confirm(`Feld "${f.label}" wirklich l√∂schen?`)) return;

    ps.customFields.splice(n-1,1);
    // remove values
    for(const r of ps.records){
      if(r.custom) delete r.custom[f.id];
    }
    saveDB();
    renderAll();
  }

  function exportDB(){
    const data = localStorage.getItem(STORAGE_KEY);
    if(!data){
      alert("Keine Daten zum Export vorhanden.");
      return;
    }
    const blob = new Blob([data], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "vertriebspartner_backup.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  async function importDB(file){
    const text = await file.text();
    const parsed = safeJSONParse(text, null);
    if(!parsed || !parsed.partners) return alert("Import fehlgeschlagen: ung√ºltige Datei.");
    db = parsed;
    saveDB();
    renderAll();
    alert("Import erfolgreich.");
  }

  function addRoleCustom(){
    const p = getActivePartner();
    const ps = getPartnerState(p.key);
    const val = ($("roleNewInput").value || "").trim();
    if(!val) return;
    if(ps.roleCustom.includes(val)) return;
    ps.roleCustom.push(val);
    $("roleNewInput").value = "";
    saveDB();
    renderAll();
  }

  // Quick focus buttons
  function focusById(id){
    const el = document.getElementById(id);
    if(el){ el.scrollIntoView({ behavior:"smooth", block:"center" }); el.focus({preventScroll:true}); }
  }

  // ===============================
  // Render All
  // ===============================
  function renderYearSelect(){
    const sel = $("yearSelect");
    sel.innerHTML = "";
    const yNow = currentYear();
    const years = [];
    for(let y=yNow-3; y<=yNow+2; y++) years.push(y);
    const prefer = db.ui.year || yNow;
    for(const y of years){
      const opt = document.createElement("option");
      opt.value = y;
      opt.textContent = String(y);
      if(y === prefer) opt.selected = true;
      sel.appendChild(opt);
    }
    sel.onchange = () => {
      db.ui.year = parseInt(sel.value,10) || yNow;
      saveDB();
      renderYearTable();
      renderDashboard();
    };
  }

  function renderAll(){
    const partner = getActivePartner();
    document.body.setAttribute("data-partner", partner.key);

    renderPartnerTabs();
    renderRecordSelect();
    renderRoleCustomInfo();
    renderYearSelect();

    $("q").value = db.ui.q || "";
    $("chkAllPartners").checked = !!db.ui.allPartners;
    $("chkOnlyOpen").checked = !!db.ui.onlyOpen;
    $("chkOnlyYear").checked = !!db.ui.onlyYear;

    renderYearTable();
    renderDashboard();
    renderHits();
    renderForm();
  }

  // ===============================
  // Wire global UI
  // ===============================
  $("btnSaveTop").onclick = () => { saveDB(); setStatus("gespeichert"); setTimeout(()=>setStatus("bereit"),800); };
  $("btnPrintTop").onclick = () => window.print();
  $("btnAddCustomFieldTop").onclick = addCustomField;
  $("btnDeleteFieldTop").onclick = deleteCustomField;
  $("btnNewRecord").onclick = newRecord;
  $("btnDeleteRecord").onclick = deleteRecord;

  $("btnExport").addEventListener("click", exportDB);
  $("importFile").addEventListener("change", (e) => {
    const f = e.target.files?.[0];
    if(f) importDB(f);
    e.target.value = "";
  });

  $("btnAddRole").onclick = addRoleCustom;

  $("q").addEventListener("input", () => {
    db.ui.q = $("q").value;
    saveDB();
    renderHits();
  });
  $("btnClearQ").onclick = () => {
    db.ui.q = "";
    $("q").value = "";
    saveDB();
    renderHits();
  };

  $("chkAllPartners").onchange = () => { db.ui.allPartners = $("chkAllPartners").checked; saveDB(); renderHits(); renderDashboard(); };
  $("chkOnlyOpen").onchange = () => { db.ui.onlyOpen = $("chkOnlyOpen").checked; saveDB(); renderHits(); renderDashboard(); };
  $("chkOnlyYear").onchange = () => { db.ui.onlyYear = $("chkOnlyYear").checked; saveDB(); renderHits(); renderDashboard(); };

  $("btnToggleHits").onclick = () => {
    const c = $("hitsCard");
    c.style.display = (c.style.display === "none" || !c.style.display) ? "block" : "none";
  };

  $("btnFocusFollowUpsTop").onclick = () => {
    // scroll to first followup input if exists
    const el = document.querySelector('[id*="_fud"]');
    if(el) el.scrollIntoView({behavior:"smooth", block:"center"});
  };
  $("btnFocusVollTop").onclick = () => focusById("vollIst");
  $("btnFocusBeihilfeTop").onclick = () => focusById("beihilfeIst");
  $("btnFocusZusatzTop").onclick = () => focusById("zusatzIst");
  $("btnFocusBkvTop").onclick = () => focusById("bkvIst");

  $("btnYearCsv").addEventListener("click", () => {
    const blob = new Blob([buildYearCsv()], { type:"text/csv;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    const partner = getActivePartner();
    const y = parseInt($("yearSelect").value,10) || currentYear();
    a.download = `jahresauswertung_${partner.name.replaceAll(" ","_")}_${y}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  });
  $("btnYearPrint").addEventListener("click", () => window.print());

  // ===============================
  // Init
  // ===============================
  loadDB();
  setStatus("bereit");
  renderAll();
})();
</script>
</body>
</html>
